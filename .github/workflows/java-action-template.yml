name: Java Gradle CI Template

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - 'gradle/**'
  
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®å®Ÿè¡Œè¨­å®š
  # pull_request:
  #   branches: [ main ]
  #   types: [opened, synchronize, reopened]
  
  workflow_dispatch:
    # inputs:
    #   test_type:
    #     description: 'ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠ'
    #     required: true
    #     default: 'unit'
    #     type: choice
    #     options:
    #       - unit
    #       - integration
    #       - all

env:
  # Gradleã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
  GRADLE_OPTS: >-
    -Dorg.gradle.daemon=false
    -Dorg.gradle.parallel=true
    -Dorg.gradle.workers.max=2
    -Dorg.gradle.jvmargs="-Xmx6g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"
  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
  GRADLE_BUILD_ACTION_CACHE_DEBUG_ENABLED: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Java ${{ matrix.java }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        java: [17, 21]
        os: [ubuntu-latest, windows-latest]
        include:
          - java: 21
            os: ubuntu-latest
            experimental: true
            additional-tests: true
      fail-fast: false
      max-parallel: 4
    
    steps:
      - name: Debug Information
        run: |
          echo "ğŸ” å®Ÿè¡Œç’°å¢ƒæƒ…å ±:"
          echo "Java: ${{ matrix.java }}"
          echo "OS: ${{ matrix.os }}"
          echo "Branch: ${{ github.ref }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Repository: ${{ github.repository }}"
          # ç’°å¢ƒå¤‰æ•°ã®ä¸€è¦§ã‚’è¡¨ç¤º
          echo "ğŸ“ ç’°å¢ƒå¤‰æ•°:"
          env | sort
      
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
      
      # Gradleã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        
      # Gradleãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
      - name: Build with Gradle
        if: matrix.os == 'ubuntu-latest'
        run: |
          chmod +x gradlew
          ./gradlew build --scan --no-daemon
      
      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run Tests Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          ./gradlew test
          # case "${{ github.event.inputs.test_type }}" in
          #   "unit")
          #     ./gradlew test
          #     ;;
          #   "integration")
          #     ./gradlew integrationTest
          #     ;;
          #   "all")
          #     ./gradlew test integrationTest
          #     ;;
          # esac
      
      - name: Run Tests Windows
        if: matrix.os == 'windows-latest'
        run: |
          gradlew.bat clean build
        shell: cmd
        
      # # ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ä¿å­˜
      # - name: Store Test Results
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: test-results-${{ matrix.java }}-${{ matrix.os }}
      #     path: |
      #       build/reports/tests/
      #     retention-days: 5
      

  quality-check:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      # å“è³ªãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œ
      - name: Run Quality Checks
        run: |
          ./gradlew test pmdMain checkstyleMain spotBugsMain
      # SonarQubeã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      # - name: SonarQube Analysis
      #   if: github.event_name != 'pull_request'
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   run: |
      #     ./gradlew sonar \
      #       -Dsonar.projectKey=${{ github.repository }} \
      #       -Dsonar.organization=your-org \
      #       -Dsonar.host.url=https://sonarcloud.io
      
      # å“è³ªãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆã®ä¿å­˜
      - name: Store Quality Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            build/reports/spotbugs/
            build/reports/checkstyle/
            build/reports/pmd/
            build/reports/tests/test/
            build/reports/jacoco/test/html/

            
          retention-days: 5

# ãƒ˜ãƒ«ãƒ—ãƒ•ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ
# 
# Gradleé–¢é€£ã®ä¾¿åˆ©ãªè¨­å®š:
# 1. build.gradle.kts ã§ã®æ¨å¥¨è¨­å®š
#    ```kotlin
#    tasks.withType<Test> {
#        useJUnitPlatform()
#        maxParallelForks = (Runtime.getRuntime().availableProcessors() / 2).takeIf { it > 0 } ?: 1
#        reports {
#            html.required.set(true)
#            junitXml.required.set(true)
#        }
#    }
#    ```
# 
# 2. gradle.properties ã®æ¨å¥¨è¨­å®š
#    org.gradle.parallel=true
#    org.gradle.caching=true
#    org.gradle.configuration-cache=true
# 
# ãƒ‡ãƒãƒƒã‚°Tips:
# - ./gradlew --scan: ãƒ“ãƒ«ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã‚’æœ‰åŠ¹åŒ–
# - ./gradlew --debug: ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–
# - ./gradlew tasks: åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º
# 
# ä¸€èˆ¬çš„ãªãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:
# 1. ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å•é¡Œ â†’ ./gradlew clean --refresh-dependencies
# 2. ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å•é¡Œ â†’ chmod +x gradlew
# 3. ãƒ¡ãƒ¢ãƒªä¸è¶³ â†’ GRADLE_OPTS ã§ JVM ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’èª¿æ•´
# 
# ä¾¿åˆ©ãªGradle Plugins:
# - id("org.springframework.boot"): Springã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
# - id("io.spring.dependency-management"): ä¾å­˜é–¢ä¿‚ç®¡ç†
# - id("org.jetbrains.kotlin.jvm"): Kotlinç”¨
# - id("com.diffplug.spotless"): ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
# - id("org.sonarqube"): SonarQubeè§£æç”¨